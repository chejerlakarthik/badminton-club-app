"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const uuid_1 = require("uuid");
const zod_1 = require("zod");
const response_1 = require("../../utils/response");
const auth_1 = require("../../utils/auth");
const database_1 = require("../../utils/database");
const events_1 = require("../../utils/events");
const CreateBookingSchema = zod_1.z.object({
    courtId: zod_1.z.string().uuid(),
    date: zod_1.z.string(),
    startTime: zod_1.z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/),
    endTime: zod_1.z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/),
    notes: zod_1.z.string().optional()
});
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, response_1.createErrorResponse)(400, 'Request body is required');
        }
        const user = (0, auth_1.getUserFromEvent)(event);
        const body = JSON.parse(event.body);
        const { courtId, date, startTime, endTime, notes } = CreateBookingSchema.parse(body);
        // Check if court exists
        const court = await database_1.DatabaseService.get(`COURT#${courtId}`, `COURT#${courtId}`);
        if (!court || !court.isActive) {
            return (0, response_1.createErrorResponse)(404, 'Court not found or inactive');
        }
        // Check for conflicting bookings
        const existingBookings = await database_1.DatabaseService.queryGSI(`COURT#${courtId}`, `BOOKING#${date}`, 'GSI2');
        const hasConflict = existingBookings.some((booking) => {
            if (booking.status === 'cancelled')
                return false;
            const existingStart = booking.startTime;
            const existingEnd = booking.endTime;
            return (startTime < existingEnd && endTime > existingStart);
        });
        if (hasConflict) {
            return (0, response_1.createErrorResponse)(400, 'Court is already booked for this time slot');
        }
        // Calculate total amount
        const startHour = parseInt(startTime.split(':')[0] || '0');
        const endHour = parseInt(endTime.split(':')[0] || '0');
        const duration = endHour - startHour;
        const totalAmount = duration * court.hourlyRate;
        const bookingId = (0, uuid_1.v4)();
        const now = new Date().toISOString();
        const booking = {
            PK: `BOOKING#${bookingId}`,
            SK: `BOOKING#${bookingId}`,
            GSI1PK: `USER#${user.userId}`,
            GSI1SK: `BOOKING#${date}#${startTime}`,
            GSI2PK: `COURT#${courtId}`,
            GSI2SK: `BOOKING#${date}#${startTime}`,
            bookingId,
            userId: user.userId,
            courtId,
            date,
            startTime,
            endTime,
            totalAmount,
            status: 'pending',
            paymentStatus: 'pending',
            notes: notes ?? 'No notes provided.',
            createdAt: now,
            updatedAt: now
        };
        await database_1.DatabaseService.put(booking);
        // Publish booking event
        await events_1.EventService.publishBookingEvent('Booking Created', {
            bookingId: booking.bookingId,
            userId: booking.userId,
            courtId: booking.courtId,
            date: booking.date,
            startTime: booking.startTime,
            endTime: booking.endTime,
            totalAmount: booking.totalAmount
        });
        return (0, response_1.createSuccessResponse)(booking, 'Booking created successfully');
    }
    catch (error) {
        console.error('Booking creation error:', error);
        if (error instanceof zod_1.z.ZodError) {
            return (0, response_1.createErrorResponse)(400, error.errors[0]?.message || 'Validation error');
        }
        if (error.message.includes('authorization')) {
            return (0, response_1.createErrorResponse)(401, error.message);
        }
        return (0, response_1.createErrorResponse)(500, 'Internal server error');
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwcC9sYW1iZGFzL2Jvb2tpbmdzL2NyZWF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwrQkFBb0M7QUFDcEMsNkJBQXdCO0FBQ3hCLG1EQUFrRjtBQUNsRiwyQ0FBb0Q7QUFDcEQsbURBQXVEO0FBQ3ZELCtDQUFrRDtBQUdsRCxNQUFNLG1CQUFtQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDakMsT0FBTyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUU7SUFDMUIsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUU7SUFDaEIsU0FBUyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLENBQUM7SUFDaEUsT0FBTyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLENBQUM7SUFDOUQsS0FBSyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7Q0FDL0IsQ0FBQyxDQUFDO0FBRUksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDekYsSUFBSSxDQUFDO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLE9BQU8sSUFBQSw4QkFBbUIsRUFBQyxHQUFHLEVBQUUsMEJBQTBCLENBQUMsQ0FBQztRQUNoRSxDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBQSx1QkFBZ0IsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUNyQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLG1CQUFtQixD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SUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQ2xCLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztZQUM1QixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87WUFDeEIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1NBQ25DLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBQSxnQ0FBcUIsRUFBQyxPQUFPLEVBQUUsOEJBQThCLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFaEQsSUFBSSxLQUFLLFlBQVksT0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzlCLE9BQU8sSUFBQSw4QkFBbUIsRUFBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLElBQUksa0JBQWtCLENBQUMsQ0FBQztRQUNwRixDQUFDO1FBRUQsSUFBSyxLQUFlLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDO1lBQ3JELE9BQU8sSUFBQSw4QkFBbUIsRUFBQyxHQUFHLEVBQUcsS0FBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFFRCxPQUFPLElBQUEsOEJBQW1CLEVBQUMsR0FBRyxFQUFFLHVCQUF1QixDQUFDLENBQUM7SUFDN0QsQ0FBQztBQUNMLENBQUMsQ0FBQztBQTdGVyxRQUFBLE9BQU8sV0E2RmxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IGNyZWF0ZVN1Y2Nlc3NSZXNwb25zZSwgY3JlYXRlRXJyb3JSZXNwb25zZSB9IGZyb20gJy4uLy4uL3V0aWxzL3Jlc3BvbnNlJztcbmltcG9ydCB7IGdldFVzZXJGcm9tRXZlbnQgfSBmcm9tICcuLi8uLi91dGlscy9hdXRoJztcbmltcG9ydCB7IERhdGFiYXNlU2VydmljZSB9IGZyb20gJy4uLy4uL3V0aWxzL2RhdGFiYXNlJztcbmltcG9ydCB7IEV2ZW50U2VydmljZSB9IGZyb20gJy4uLy4uL3V0aWxzL2V2ZW50cyc7XG5pbXBvcnQgeyBCb29raW5nLCBDb3VydCB9IGZyb20gJy4uLy4uL3R5cGVzJztcblxuY29uc3QgQ3JlYXRlQm9va2luZ1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgICBjb3VydElkOiB6LnN0cmluZygpLnV1aWQoKSxcbiAgICBkYXRlOiB6LnN0cmluZygpLFxuICAgIHN0YXJ0VGltZTogei5zdHJpbmcoKS5yZWdleCgvXihbMC0xXT9bMC05XXwyWzAtM10pOlswLTVdWzAtOV0kLyksXG4gICAgZW5kVGltZTogei5zdHJpbmcoKS5yZWdleCgvXihbMC0xXT9bMC05XXwyWzAtM10pOlswLTVdWzAtOV0kLyksXG4gICAgbm90ZXM6IHouc3RyaW5nKCkub3B0aW9uYWwoKVxufSk7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHVzZXIgPSBnZXRVc2VyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG4gICAgICAgIGNvbnN0IHsgY291cnRJZCwgZGF0ZSwgc3RhcnRUaW1lLCBlbmRUaW1lLCBub3RlcyB9ID0gQ3JlYXRlQm9va2luZ1NjaGVtYS5wYXJzZShib2R5KTtcblxuICAgICAgICAvLyBDaGVjayBpZiBjb3VydCBleGlzdHNcbiAgICAgICAgY29uc3QgY291cnQgPSBhd2FpdCBEYXRhYmFzZVNlcnZpY2UuZ2V0KGBDT1VSVCMke2NvdXJ0SWR9YCwgYENPVVJUIyR7Y291cnRJZH1gKSBhcyBDb3VydDtcbiAgICAgICAgaWYgKCFjb3VydCB8fCAhY291cnQuaXNBY3RpdmUpIHtcbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDQwNCwgJ0NvdXJ0IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgZm9yIGNvbmZsaWN0aW5nIGJvb2tpbmdzXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nQm9va2luZ3MgPSBhd2FpdCBEYXRhYmFzZVNlcnZpY2UucXVlcnlHU0koXG4gICAgICAgICAgICBgQ09VUlQjJHtjb3VydElkfWAsXG4gICAgICAgICAgICBgQk9PS0lORyMke2RhdGV9YCxcbiAgICAgICAgICAgICdHU0kyJ1xuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGhhc0NvbmZsaWN0ID0gZXhpc3RpbmdCb29raW5ncy5zb21lKChib29raW5nOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGlmIChib29raW5nLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdTdGFydCA9IGJvb2tpbmcuc3RhcnRUaW1lO1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdFbmQgPSBib29raW5nLmVuZFRpbWU7XG5cbiAgICAgICAgICAgIHJldHVybiAoc3RhcnRUaW1lIDwgZXhpc3RpbmdFbmQgJiYgZW5kVGltZSA+IGV4aXN0aW5nU3RhcnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoaGFzQ29uZmxpY3QpIHtcbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDQwMCwgJ0NvdXJ0IGlzIGFscmVhZHkgYm9va2VkIGZvciB0aGlzIHRpbWUgc2xvdCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIHRvdGFsIGFtb3VudFxuICAgICAgICBjb25zdCBzdGFydEhvdXIgPSBwYXJzZUludChzdGFydFRpbWUuc3BsaXQoJzonKVswXSB8fCAnMCcpO1xuICAgICAgICBjb25zdCBlbmRIb3VyID0gcGFyc2VJbnQoZW5kVGltZS5zcGxpdCgnOicpWzBdIHx8ICcwJyk7XG4gICAgICAgIGNvbnN0IGR1cmF0aW9uID0gZW5kSG91ciAtIHN0YXJ0SG91cjtcbiAgICAgICAgY29uc3QgdG90YWxBbW91bnQgPSBkdXJhdGlvbiAqIGNvdXJ0LmhvdXJseVJhdGU7XG5cbiAgICAgICAgY29uc3QgYm9va2luZ0lkID0gdXVpZHY0KCk7XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICAgICAgICBjb25zdCBib29raW5nOiBCb29raW5nID0ge1xuICAgICAgICAgICAgUEs6IGBCT09LSU5HIyR7Ym9va2luZ0lkfWAsXG4gICAgICAgICAgICBTSzogYEJPT0tJTkcjJHtib29raW5nSWR9YCxcbiAgICAgICAgICAgIEdTSTFQSzogYFVTRVIjJHt1c2VyLnVzZXJJZH1gLFxuICAgICAgICAgICAgR1NJMVNLOiBgQk9PS0lORyMke2RhdGV9IyR7c3RhcnRUaW1lfWAsXG4gICAgICAgICAgICBHU0kyUEs6IGBDT1VSVCMke2NvdXJ0SWR9YCxcbiAgICAgICAgICAgIEdTSTJTSzogYEJPT0tJTkcjJHtkYXRlfSMke3N0YXJ0VGltZX1gLFxuICAgICAgICAgICAgYm9va2luZ0lkLFxuICAgICAgICAgICAgdXNlcklkOiB1c2VyLnVzZXJJZCxcbiAgICAgICAgICAgIGNvdXJ0SWQsXG4gICAgICAgICAgICBkYXRlLFxuICAgICAgICAgICAgc3RhcnRUaW1lLFxuICAgICAgICAgICAgZW5kVGltZSxcbiAgICAgICAgICAgIHRvdGFsQW1vdW50LFxuICAgICAgICAgICAgc3RhdHVzOiAncGVuZGluZycsXG4gICAgICAgICAgICBwYXltZW50U3RhdHVzOiAncGVuZGluZycsXG4gICAgICAgICAgICBub3Rlczogbm90ZXMgPz8gJ05vIG5vdGVzIHByb3ZpZGVkLicsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93XG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgRGF0YWJhc2VTZXJ2aWNlLnB1dChib29raW5nKTtcblxuICAgICAgICAvLyBQdWJsaXNoIGJvb2tpbmcgZXZlbnRcbiAgICAgICAgYXdhaXQgRXZlbnRTZXJ2aWNlLnB1Ymxpc2hCb29raW5nRXZlbnQoJ0Jvb2tpbmcgQ3JlYXRlZCcsIHtcbiAgICAgICAgICAgIGJvb2tpbmdJZDogYm9va2luZy5ib29raW5nSWQsXG4gICAgICAgICAgICB1c2VySWQ6IGJvb2tpbmcudXNlcklkLFxuICAgICAgICAgICAgY291cnRJZDogYm9va2luZy5jb3VydElkLFxuICAgICAgICAgICAgZGF0ZTogYm9va2luZy5kYXRlLFxuICAgICAgICAgICAgc3RhcnRUaW1lOiBib29raW5nLnN0YXJ0VGltZSxcbiAgICAgICAgICAgIGVuZFRpbWU6IGJvb2tpbmcuZW5kVGltZSxcbiAgICAgICAgICAgIHRvdGFsQW1vdW50OiBib29raW5nLnRvdGFsQW1vdW50XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBjcmVhdGVTdWNjZXNzUmVzcG9uc2UoYm9va2luZywgJ0Jvb2tpbmcgY3JlYXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdCb29raW5nIGNyZWF0aW9uIGVycm9yOicsIGVycm9yKTtcblxuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsIGVycm9yLmVycm9yc1swXT8ubWVzc2FnZSB8fCAnVmFsaWRhdGlvbiBlcnJvcicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKChlcnJvciBhcyBFcnJvcikubWVzc2FnZS5pbmNsdWRlcygnYXV0aG9yaXphdGlvbicpKSB7XG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDEsIChlcnJvciBhcyBFcnJvcikubWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59OyJdfQ==