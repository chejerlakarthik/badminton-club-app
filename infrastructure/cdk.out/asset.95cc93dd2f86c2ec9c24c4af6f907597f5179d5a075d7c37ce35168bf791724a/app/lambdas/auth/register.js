"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const uuid_1 = require("uuid");
const zod_1 = require("zod");
const response_1 = require("../../utils/response");
const auth_1 = require("../../utils/auth");
const database_1 = require("../../utils/database");
const events_1 = require("../../utils/events");
const RegisterSchema = zod_1.z.object({
    firstName: zod_1.z.string().min(1),
    lastName: zod_1.z.string().min(1),
    email: zod_1.z.string().email(),
    password: zod_1.z.string().min(6),
    phone: zod_1.z.string().min(10),
    membershipType: zod_1.z.enum(['basic', 'premium', 'student', 'family']).optional(),
    skillLevel: zod_1.z.enum(['beginner', 'intermediate', 'advanced']).optional()
});
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, response_1.createErrorResponse)(400, 'Request body is required');
        }
        const body = JSON.parse(event.body);
        const validatedData = RegisterSchema.parse(body);
        // Check if user already exists
        const existingUser = await database_1.DatabaseService.query('USER#', validatedData.email);
        if (existingUser.length > 0) {
            return (0, response_1.createErrorResponse)(400, 'User already exists');
        }
        const userId = (0, uuid_1.v4)();
        const passwordHash = await (0, auth_1.hashPassword)(validatedData.password);
        const now = new Date().toISOString();
        const membershipExpiry = new Date();
        membershipExpiry.setFullYear(membershipExpiry.getFullYear() + 1);
        const user = {
            PK: `USER#${userId}`,
            SK: `USER#${userId}`,
            userId,
            email: validatedData.email,
            firstName: validatedData.firstName,
            lastName: validatedData.lastName,
            phone: validatedData.phone,
            passwordHash,
            membershipType: validatedData.membershipType || 'basic',
            membershipExpiry: membershipExpiry.toISOString(),
            skillLevel: validatedData.skillLevel || 'beginner',
            role: 'member',
            isActive: true,
            createdAt: now,
            updatedAt: now
        };
        await database_1.DatabaseService.put(user);
        // Generate JWT token
        const token = (0, auth_1.generateToken)({
            userId: user.userId,
            email: user.email,
            role: user.role
        });
        // Publish user registration event
        await events_1.EventService.publishUserEvent('User Registered', {
            userId: user.userId,
            email: user.email,
            firstName: user.firstName,
            lastName: user.lastName
        });
        const responseData = {
            token,
            user: {
                id: user.userId,
                firstName: user.firstName,
                lastName: user.lastName,
                email: user.email,
                membershipType: user.membershipType,
                role: user.role
            }
        };
        return (0, response_1.createSuccessResponse)(responseData, 'User registered successfully');
    }
    catch (error) {
        console.error('Registration error:', error);
        if (error instanceof zod_1.z.ZodError) {
            return (0, response_1.createErrorResponse)(400, error.errors[0]?.message || 'Validation error');
        }
        return (0, response_1.createErrorResponse)(500, 'Internal server error');
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXBwL2xhbWJkYXMvYXV0aC9yZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwrQkFBb0M7QUFDcEMsNkJBQXdCO0FBQ3hCLG1EQUFrRjtBQUNsRiwyQ0FBK0Q7QUFDL0QsbURBQXVEO0FBQ3ZELCtDQUFrRDtBQUdsRCxNQUFNLGNBQWMsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQzVCLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUM1QixRQUFRLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDM0IsS0FBSyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUU7SUFDekIsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNCLEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUN6QixjQUFjLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzVFLFVBQVUsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtDQUMxRSxDQUFDLENBQUM7QUFFSSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUN6RixJQUFJLENBQUM7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsT0FBTyxJQUFBLDhCQUFtQixFQUFDLEdBQUcsRUFBRSwwQkFB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QUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssWUFBWSxPQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDOUIsT0FBTyxJQUFBLDhCQUFtQixFQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3BGLENBQUM7UUFFRCxPQUFPLElBQUEsOEJBQW1CLEVBQUMsR0FBRyxFQUFFLHVCQUF1QixDQUFDLENBQUM7SUFDN0QsQ0FBQztBQUNMLENBQUMsQ0FBQztBQTlFVyxRQUFBLE9BQU8sV0E4RWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IGNyZWF0ZVN1Y2Nlc3NSZXNwb25zZSwgY3JlYXRlRXJyb3JSZXNwb25zZSB9IGZyb20gJy4uLy4uL3V0aWxzL3Jlc3BvbnNlJztcbmltcG9ydCB7IGhhc2hQYXNzd29yZCwgZ2VuZXJhdGVUb2tlbiB9IGZyb20gJy4uLy4uL3V0aWxzL2F1dGgnO1xuaW1wb3J0IHsgRGF0YWJhc2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdXRpbHMvZGF0YWJhc2UnO1xuaW1wb3J0IHsgRXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdXRpbHMvZXZlbnRzJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbmNvbnN0IFJlZ2lzdGVyU2NoZW1hID0gei5vYmplY3Qoe1xuICAgIGZpcnN0TmFtZTogei5zdHJpbmcoKS5taW4oMSksXG4gICAgbGFzdE5hbWU6IHouc3RyaW5nKCkubWluKDEpLFxuICAgIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXG4gICAgcGFzc3dvcmQ6IHouc3RyaW5nKCkubWluKDYpLFxuICAgIHBob25lOiB6LnN0cmluZygpLm1pbigxMCksXG4gICAgbWVtYmVyc2hpcFR5cGU6IHouZW51bShbJ2Jhc2ljJywgJ3ByZW1pdW0nLCAnc3R1ZGVudCcsICdmYW1pbHknXSkub3B0aW9uYWwoKSxcbiAgICBza2lsbExldmVsOiB6LmVudW0oWydiZWdpbm5lcicsICdpbnRlcm1lZGlhdGUnLCAnYWR2YW5jZWQnXSkub3B0aW9uYWwoKVxufSk7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuICAgICAgICBjb25zdCB2YWxpZGF0ZWREYXRhID0gUmVnaXN0ZXJTY2hlbWEucGFyc2UoYm9keSk7XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgdXNlciBhbHJlYWR5IGV4aXN0c1xuICAgICAgICBjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCBEYXRhYmFzZVNlcnZpY2UucXVlcnkoJ1VTRVIjJywgdmFsaWRhdGVkRGF0YS5lbWFpbCk7XG4gICAgICAgIGlmIChleGlzdGluZ1VzZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAwLCAnVXNlciBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXNlcklkID0gdXVpZHY0KCk7XG4gICAgICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGF3YWl0IGhhc2hQYXNzd29yZCh2YWxpZGF0ZWREYXRhLnBhc3N3b3JkKTtcbiAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgICBjb25zdCBtZW1iZXJzaGlwRXhwaXJ5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgbWVtYmVyc2hpcEV4cGlyeS5zZXRGdWxsWWVhcihtZW1iZXJzaGlwRXhwaXJ5LmdldEZ1bGxZZWFyKCkgKyAxKTtcblxuICAgICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICAgICAgUEs6IGBVU0VSIyR7dXNlcklkfWAsXG4gICAgICAgICAgICBTSzogYFVTRVIjJHt1c2VySWR9YCxcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGVtYWlsOiB2YWxpZGF0ZWREYXRhLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB2YWxpZGF0ZWREYXRhLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB2YWxpZGF0ZWREYXRhLmxhc3ROYW1lLFxuICAgICAgICAgICAgcGhvbmU6IHZhbGlkYXRlZERhdGEucGhvbmUsXG4gICAgICAgICAgICBwYXNzd29yZEhhc2gsXG4gICAgICAgICAgICBtZW1iZXJzaGlwVHlwZTogdmFsaWRhdGVkRGF0YS5tZW1iZXJzaGlwVHlwZSB8fCAnYmFzaWMnLFxuICAgICAgICAgICAgbWVtYmVyc2hpcEV4cGlyeTogbWVtYmVyc2hpcEV4cGlyeS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgc2tpbGxMZXZlbDogdmFsaWRhdGVkRGF0YS5za2lsbExldmVsIHx8ICdiZWdpbm5lcicsXG4gICAgICAgICAgICByb2xlOiAnbWVtYmVyJyxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IG5vd1xuICAgICAgICB9O1xuXG4gICAgICAgIGF3YWl0IERhdGFiYXNlU2VydmljZS5wdXQodXNlcik7XG5cbiAgICAgICAgLy8gR2VuZXJhdGUgSldUIHRva2VuXG4gICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXIudXNlcklkLFxuICAgICAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgICAgICByb2xlOiB1c2VyLnJvbGVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUHVibGlzaCB1c2VyIHJlZ2lzdHJhdGlvbiBldmVudFxuICAgICAgICBhd2FpdCBFdmVudFNlcnZpY2UucHVibGlzaFVzZXJFdmVudCgnVXNlciBSZWdpc3RlcmVkJywge1xuICAgICAgICAgICAgdXNlcklkOiB1c2VyLnVzZXJJZCxcbiAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB1c2VyLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlRGF0YSA9IHtcbiAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIGlkOiB1c2VyLnVzZXJJZCxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgICAgIG1lbWJlcnNoaXBUeXBlOiB1c2VyLm1lbWJlcnNoaXBUeXBlLFxuICAgICAgICAgICAgICAgIHJvbGU6IHVzZXIucm9sZVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBjcmVhdGVTdWNjZXNzUmVzcG9uc2UocmVzcG9uc2VEYXRhLCAnVXNlciByZWdpc3RlcmVkIHN1Y2Nlc3NmdWxseScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlZ2lzdHJhdGlvbiBlcnJvcjonLCBlcnJvcik7XG5cbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2Ygei5ab2RFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAwLCBlcnJvci5lcnJvcnNbMF0/Lm1lc3NhZ2UgfHwgJ1ZhbGlkYXRpb24gZXJyb3InKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDUwMCwgJ0ludGVybmFsIHNlcnZlciBlcnJvcicpO1xuICAgIH1cbn07Il19